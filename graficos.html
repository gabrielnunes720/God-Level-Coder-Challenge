<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Análise Gráfica</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        select[multiple] { height: 120px; }
        select[multiple] option { padding: 4px 8px; }
    </style>
</head>
<body class="bg-gray-100 font-sans p-6 md:p-10">

    <nav class="container mx-auto max-w-7xl mb-6">
        <div class="bg-white p-2 rounded-lg shadow-md flex space-x-2">
            <a href="index.html" class="flex-1 text-center px-4 py-2 bg-gray-200 text-gray-700 font-medium rounded-md hover:bg-gray-300">
                Painel Resumo (KPIs)
            </a>
            <a href="graficos.html" class="flex-1 text-center px-4 py-2 bg-blue-600 text-white font-bold rounded-md shadow">
                Análise Gráfica
            </a>
        </div>
    </nav>
    <div class="container mx-auto max-w-7xl">
        <h1 class="text-3xl font-bold text-gray-800 mb-6">Análise Gráfica</h1>

        <div id="filtros" class="bg-white p-6 rounded-lg shadow-md mb-8">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Filtros de Análise</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                <div class="flex flex-col">
                    <label for="loja" class="font-medium text-gray-700 mb-2">Loja (Múltipla)</label>
                    <select id="loja" multiple class="border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                        <option value="Challenge Burger" selected>Challenge Burger</option>
                        <option value="Challenge Pizza" selected>Challenge Pizza</option>
                        <option value="Challenge Sushi" selected>Challenge Sushi</option>
                    </select>
                </div>
                <div class="flex flex-col">
                    <label for="canal" class="font-medium text-gray-700 mb-2">Canal (Múltipla)</label>
                    <select id="canal" multiple class="border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                        <option value="iFood" selected>iFood</option>
                        <option value="Rappi" selected>Rappi</option>
                        <option value="WhatsApp">WhatsApp</option>
                        <option value="Presencial">Presencial</option>
                        <option value="App Próprio">App Próprio</option>
                        <option value="Uber Eats">Uber Eats</option>
                    </select>
                </div>
                <div class="flex flex-col">
                    <label for="dia" class="font-medium text-gray-700 mb-2">Dia da Semana</label>
                    <select id="dia" class="border border-gray-300 rounded-lg p-2 h-[42px] bg-white focus:ring-2 focus:ring-blue-500 focus:outline-none">
                        <option value="">Todos os dias</option>
                        <option value="2">Segunda</option>
                        <option value="3">Terça</option>
                        <option value="4">Quarta</option>
                        <option value="5">Quinta</option> 
                        <option value="6">Sexta</option>
                        <option value="7">Sábado</option>
                        <option value="1">Domingo</option>
                    </select>
                </div>
                <div class="flex flex-col">
                    <label for="periodo" class="font-medium text-gray-700 mb-2">Período</label>
                    <select id="periodo" class="border border-gray-300 rounded-lg p-2 h-[42px] bg-white focus:ring-2 focus:ring-blue-500 focus:outline-none">
                        <option value="30" selected>Últimos 30 dias</option>
                        <option value="90">Últimos 90 dias</option>
                        <option value="180">Últimos 6 meses</option>
                    </select>
                </div>
            </div>
            <div class="mt-6">
                <button id="analisarBtn" class="w-full sm:w-auto px-8 py-3 bg-blue-600 text-white font-bold rounded-lg shadow-md hover:bg-blue-700 transition duration-200">
                    Gerar Gráficos
                </button>
            </div>
        </div>
        <hr class="my-6">

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h3 class="text-lg font-semibold text-gray-700 mb-4">Faturamento por Dia e Loja</h3>
                <div class="relative" style="height: 400px;" id="graficoVendasDia-container">
                    <canvas id="graficoVendasPorDia"></canvas>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md">
                <h3 class="text-lg font-semibold text-gray-700 mb-4">Pedidos Concluídos vs. Cancelados</h3>
                 <div class="relative" style="height: 400px;" id="graficoStatus-container">
                    <canvas id="graficoPedidosStatus"></canvas>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md">
                <h3 class="text-lg font-semibold text-gray-700 mb-4">Top 7 Canais (Pedidos Concluídos)</h3>
                 <div class="relative" style="height: 400px;" id="graficoCanal-container">
                    <canvas id="graficoPedidosCanal"></canvas>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md">
                <h3 class="text-lg font-semibold text-gray-700 mb-4">Pedidos por Hora do Dia (Concluídos)</h3>
                 <div class="relative" style="height: 400px;" id="graficoHora-container">
                    <canvas id="graficoPedidosHora"></canvas>
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- 1. Selecionar Elementos ---
        const lojaSelect = document.getElementById('loja');
        const canalSelect = document.getElementById('canal');
        const diaSelect = document.getElementById('dia');
        const periodoSelect = document.getElementById('periodo'); // Novo
        const analisarBtn = document.getElementById('analisarBtn');
        
        // Variáveis para guardar os gráficos e poder destruí-los
        let chartVendasDia = null;
        let chartStatus = null;
        let chartCanal = null;
        let chartHora = null;

        // Cores Padrão
        const CHART_COLORS = ['#3B82F6', '#10B981', '#EF4444', '#F59E0B', '#6366F1', '#EC4899', '#8B5CF6'];
        const CHART_COLORS_OPACITY = CHART_COLORS.map(color => color + '33'); // 20% opacidade

        /**
         * Função auxiliar para pegar valores múltiplos
         */
        function getValoresSelectMultiplo(selectElement) {
            return Array.from(selectElement.selectedOptions).map(option => option.value);
        }
        
        /**
         * Função auxiliar para mostrar "Carregando"
         */
        function showLoading(containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="flex items-center justify-center h-full"><p class="text-gray-500">Carregando gráfico...</p></div>`;
        }
        
        /**
         * Função auxiliar para recriar o canvas
         */
        function resetCanvas(containerId, canvasId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            const canvas = document.createElement('canvas');
            canvas.id = canvasId;
            container.appendChild(canvas);
            return canvas.getContext('2d');
        }

        // --- 2. Ouvinte do Botão ---
        analisarBtn.addEventListener('click', () => {
            // --- 3. Coletar Filtros ---
            const lojas = getValoresSelectMultiplo(lojaSelect);
            const canais = getValoresSelectMultiplo(canalSelect);
            const dia = diaSelect.value;
            const dias = periodoSelect.value; // Novo

            // --- 4. Montar URL ---
            const params = new URLSearchParams();
            lojas.forEach(loja => params.append('loja', loja));
            canais.forEach(canal => params.append('canal', canal));
            if (dia) params.append('dia_semana', dia);
            params.append('dias', dias);
            const queryString = params.toString();

            // --- 5. Chamar as APIs dos Gráficos ---
            carregarGraficoVendasPorDia(queryString);
            carregarGraficoStatus(queryString);
            carregarGraficoCanal(queryString);
            carregarGraficoHora(queryString);
        });

        // --- Função Gráfico 1: Vendas por Dia (Linha) ---
        function carregarGraficoVendasPorDia(queryString) {
            const url = `http://127.0.0.1:5000/api/graficos/vendas-por-dia-loja?${queryString}`;
            showLoading('graficoVendasDia-container');
            
            fetch(url).then(res => res.json()).then(data => {
                const ctx = resetCanvas('graficoVendasDia-container', 'graficoVendasPorDia');
                if (chartVendasDia) chartVendasDia.destroy();
                
                data.datasets.forEach((dataset, index) => {
                    dataset.borderColor = CHART_COLORS[index % CHART_COLORS.length];
                    dataset.backgroundColor = CHART_COLORS_OPACITY[index % CHART_COLORS_OPACITY.length];
                    dataset.fill = true;
                    dataset.tension = 0.1;
                });

                chartVendasDia = new Chart(ctx, {
                    type: 'line', data: data,
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
                });
            }).catch(e => console.error('Erro Gráfico 1:', e));
        }

        // --- Função Gráfico 2: Pedidos por Status (Pizza) ---
        function carregarGraficoStatus(queryString) {
            const url = `http://127.0.0.1:5000/api/graficos/pedidos-por-status?${queryString}`;
            showLoading('graficoStatus-container');
            
            fetch(url).then(res => res.json()).then(data => {
                const ctx = resetCanvas('graficoStatus-container', 'graficoPedidosStatus');
                if (chartStatus) chartStatus.destroy();
                
                chartStatus = new Chart(ctx, {
                    type: 'doughnut', // Gráfico de Rosca
                    data: {
                        labels: data.labels,
                        datasets: [{
                            data: data.data,
                            backgroundColor: ['#10B981', '#EF4444'], // Verde para Concluído, Vermelho para Cancelado
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            }).catch(e => console.error('Erro Gráfico 2:', e));
        }

        // --- Função Gráfico 3: Pedidos por Canal (Barras Horizontais) ---
        function carregarGraficoCanal(queryString) {
            const url = `http://127.0.0.1:5000/api/graficos/pedidos-por-canal?${queryString}`;
            showLoading('graficoCanal-container');
            
            fetch(url).then(res => res.json()).then(data => {
                const ctx = resetCanvas('graficoCanal-container', 'graficoPedidosCanal');
                if (chartCanal) chartCanal.destroy();
                
                chartCanal = new Chart(ctx, {
                    type: 'bar', // Tipo 'bar'
                    data: {
                        labels: data.labels,
                        datasets: [{
                            label: 'Total de Pedidos',
                            data: data.data,
                            backgroundColor: CHART_COLORS_OPACITY,
                            borderColor: CHART_COLORS,
                            borderWidth: 1
                        }]
                    },
                    options: {
                        indexAxis: 'y', // <-- Isso torna a barra horizontal
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } } // Esconde a legenda
                    }
                });
            }).catch(e => console.error('Erro Gráfico 3:', e));
        }

        // --- Função Gráfico 4: Pedidos por Hora (Barras Verticais) ---
        function carregarGraficoHora(queryString) {
            const url = `http://127.0.0.1:5000/api/graficos/pedidos-por-hora?${queryString}`;
            showLoading('graficoHora-container');
            
            fetch(url).then(res => res.json()).then(data => {
                const ctx = resetCanvas('graficoHora-container', 'graficoPedidosHora');
                if (chartHora) chartHora.destroy();
                
                chartHora = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            label: 'Total de Pedidos',
                            data: data.data,
                            backgroundColor: CHART_COLORS_OPACITY[0],
                            borderColor: CHART_COLORS[0],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { y: { beginAtZero: true } }
                    }
                });
            }).catch(e => console.error('Erro Gráfico 4:', e));
        }
        
        // --- Chamar uma vez no carregamento inicial ---
        document.addEventListener('DOMContentLoaded', () => {
             analisarBtn.click();
        });

    </script>
</body>
</html>