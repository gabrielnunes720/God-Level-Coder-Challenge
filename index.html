<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Resumo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* Estilos normais */
        select[multiple] { height: 120px; }
        select[multiple] option { padding: 4px 8px; }

        /* Estilos que SÓ se aplicam ao imprimir */
        @media print {
            /* Esconde tudo que não queremos no PDF */
            body > nav, 
            div#filtros, 
            h1,
            hr {
                display: none !important;
            }

            /* Garante que a área do relatório use 100% da página */
            body, 
            #area-exportavel {
                margin: 0 !important;
                padding: 0 !important;
                width: 100% !important;
                min-width: 0 !important;
            }
            
            #area-exportavel {
                /* Remove sombras e fundos desnecessários */
                box-shadow: none !important;
                background-color: #ffffff !important;
            }
            
            /* Força os cards de KPI a terem 2 colunas para caber no A4 */
            #kpi-cards-container {
                grid-template-columns: repeat(2, minmax(0, 1fr)) !important;
            }
            
            /* Garante que os cards e a tabela tenham bordas visíveis */
            .bg-white {
                background-color: #ffffff !important;
                border: 1px solid #e2e8f0 !important;
                box-shadow: none !important;
            }
            
            /* Melhora a formatação da tabela para impressão */
            table {
                width: 100% !important;
                border-collapse: collapse !important;
            }
            
            /* Repete o cabeçalho da tabela em cada nova página */
            thead {
                display: table-header-group !important;
            }
            
            tbody, tr {
                /* Evita que uma linha da tabela seja cortada no meio */
                page-break-inside: avoid !important;
            }
            
            th, td {
                border: 1px solid #e2e8f0 !important;
                padding: 8px !important;
            }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans p-6 md:p-10">

    <nav class="container mx-auto max-w-7xl mb-6">
        <div class="bg-white p-2 rounded-lg shadow-md flex space-x-2">
            <a href="index.html" class="flex-1 text-center px-4 py-2 bg-blue-600 text-white font-bold rounded-md shadow">
                Painel Resumo (KPIs)
            </a>
            <a href="graficos.html" class="flex-1 text-center px-4 py-2 bg-gray-200 text-gray-700 font-medium rounded-md hover:bg-gray-300">
                Análise Gráfica
            </a>
        </div>
    </nav>
    <div class="container mx-auto max-w-7xl">
        <h1 class="text-3xl font-bold text-gray-800 mb-6">Painel de Análise de Vendas</h1>

        <div id="filtros" class="bg-white p-6 rounded-lg shadow-md mb-8">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Filtros de Análise</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-6">
                <div class="flex flex-col">
                    <label for="loja" class="font-medium text-gray-700 mb-2">Loja (Múltipla)</label>
                    <select id="loja" multiple class="border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                        <option value="Challenge Burger" selected>Challenge Burger</option>
                        <option value="Challenge Pizza" selected>Challenge Pizza</option>
                        <option value="Challenge Sushi" selected>Challenge Sushi</option>
                    </select>
                </div>
                <div class="flex flex-col">
                    <label for="canal" class="font-medium text-gray-700 mb-2">Canal (Múltipla)</label>
                    <select id="canal" multiple class="border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                        <option value="iFood" selected>iFood</option>
                        <option value="Rappi" selected>Rappi</option>
                        <option value="WhatsApp">WhatsApp</option>
                        <option value="Presencial">Presencial</option>
                        <option value="App Próprio">App Próprio</option>
                        <option value="Uber Eats">Uber Eats</option>
                    </select>
                </div>
                <div class="flex flex-col">
                    <label for="dia" class="font-medium text-gray-700 mb-2">Dia da Semana</label>
                    <select id="dia" class="border border-gray-300 rounded-lg p-2 h-[42px] bg-white focus:ring-2 focus:ring-blue-500 focus:outline-none">
                        <option value="">Todos os dias</option>
                        <option value="2">Segunda</option>
                        <option value="3">Terça</option>
                        <option value="4">Quarta</option>
                        <option value="5">Quinta</option> 
                        <option value="6">Sexta</option>
                        <option value="7">Sábado</option>
                        <option value="1">Domingo</option>
                    </select>
                </div>
                <div class="flex flex-col">
                    <label for="hora_inicio" class="font-medium text-gray-700 mb-2">Horário (0-23)</label>
                    <div class="flex items-center space-x-2">
                        <input id="hora_inicio" type="number" value="0" min="0" max="23" class="border border-gray-300 rounded-lg p-2 w-full focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="De">
                        <span class="text-gray-600">-</span>
                        <input id="hora_fim" type="number" value="23" min="0" max="23" class="border border-gray-300 rounded-lg p-2 w-full focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="Até">
                    </div>
                </div>
                <div class="flex flex-col">
                    <label for="ordenacao" class="font-medium text-gray-700 mb-2">Ordenação</label>
                    <select id="ordenacao" class="border border-gray-300 rounded-lg p-2 h-[42px] bg-white focus:ring-2 focus:ring-blue-500 focus:outline-none">
                        <option value="DESC" selected>Mais vendidos</option>
                        <option value="ASC">Menos vendidos</option>
                    </select>
                </div>
                <div class="flex flex-col">
                    <label for="limite" class="font-medium text-gray-700 mb-2">Mostrar (Top N)</label>
                    <input id="limite" type="number" value="10" min="1" class="border border-gray-300 rounded-lg p-2 h-[42px] focus:ring-2 focus:ring-blue-500 focus:outline-none">
                </div>
            </div>
            
            <div class="mt-6 flex flex-wrap gap-4">
                <button id="analisarBtn" class="px-8 py-3 bg-blue-600 text-white font-bold rounded-lg shadow-md hover:bg-blue-700 transition duration-200">
                    Analisar
                </button>
                <button id="exportarPdfBtn" class="px-8 py-3 bg-gray-600 text-white font-bold rounded-lg shadow-md hover:bg-gray-700 transition duration-200">
                    Imprimir / Salvar PDF
                </button>
            </div>
        </div>

        <div id="area-exportavel" class="mt-8">

            <div id="painel-kpis">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Resumo Financeiro e de Clientes</h2>
                <div id="kpi-cards-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    </div>
            </div>
            
            <hr class="my-6">

            <h2 class="text-xl font-semibold text-gray-700 mb-4">Resultados - Top Produtos</h2>
            <div class="bg-white shadow-md rounded-lg overflow-hidden">
                <table class="w-full min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Produto</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Loja</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Canal</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vendas (Unidades)</th>
                        </tr>
                    </thead>
                    <tbody id="resultados-tbody" class="bg-white divide-y divide-gray-200">
                        </tbody>
                </table>
            </div>

        </div>
        </div>

    <script>
        // --- 1. Selecionar Elementos ---
        const lojaSelect = document.getElementById('loja');
        const canalSelect = document.getElementById('canal');
        const diaSelect = document.getElementById('dia');
        const horaInicioInput = document.getElementById('hora_inicio');
        const horaFimInput = document.getElementById('hora_fim');
        const ordenacaoSelect = document.getElementById('ordenacao');
        const limiteInput = document.getElementById('limite');
        
        const analisarBtn = document.getElementById('analisarBtn');
        const exportarPdfBtn = document.getElementById('exportarPdfBtn'); // 2. Seleciona o botão
        
        const resultadosTbody = document.getElementById('resultados-tbody');
        const kpiContainer = document.getElementById('kpi-cards-container');

        // (O resto das funções de seleção e o 'getValoresSelectMultiplo' continuam iguais)
        function getValoresSelectMultiplo(selectElement) {
            return Array.from(selectElement.selectedOptions).map(option => option.value);
        }

        // --- 2. Ouvinte do Botão "Analisar" ---
        analisarBtn.addEventListener('click', () => {
            const lojas = getValoresSelectMultiplo(lojaSelect);
            const canais = getValoresSelectMultiplo(canalSelect);
            const dia = diaSelect.value;
            const horaInicio = horaInicioInput.value;
            const horaFim = horaFimInput.value;
            const ordenacao = ordenacaoSelect.value;
            const limite = limiteInput.value;

            const params = new URLSearchParams();
            lojas.forEach(loja => params.append('loja', loja));
            canais.forEach(canal => params.append('canal', canal));
            params.append('hora_inicio', horaInicio);
            params.append('hora_fim', horaFim);
            params.append('ordenacao', ordenacao);
            params.append('limite', limite);
            if (dia) params.append('dia_semana', dia);

            const queryString = params.toString();
            
            chamarApiTopProdutos(queryString);
            chamarApiResumoKpis(queryString);
        });

        // --- ⬇️ 3. OUVINTE DO BOTÃO "EXPORTAR" (MUDOU) ⬇️ ---
        exportarPdfBtn.addEventListener('click', () => {
            // Ação super simples: apenas chama a impressão do navegador
            window.print();
        });

        
        // --- Função 1: Busca os Top Produtos (Tabela) ---
        function chamarApiTopProdutos(queryString) {
            const url = `http://127.0.0.1:5000/api/analise/top-produtos?${queryString}`;
            resultadosTbody.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-gray-500">Carregando Top Produtos...</td></tr>`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    resultadosTbody.innerHTML = ''; 
                    if (data.length === 0) {
                        resultadosTbody.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-gray-500">Nenhum resultado encontrado.</td></tr>`;
                        return;
                    }
                    data.forEach(item => {
                        const tr = document.createElement('tr');
                        tr.className = "hover:bg-gray-50";
                        tr.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.produto}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${item.loja}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${item.canal}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-800">${item.vendas.toFixed(0)}</td>
                        `;
                        resultadosTbody.appendChild(tr);
                    });
                })
                .catch(error => {
                    console.error('Erro API Top Produtos:', error);
                    resultadosTbody.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-red-500">Erro ao carregar dados.</td></tr>`;
                });
        }

        // --- Função 2: Busca os KPIs (Cards) ---
        function chamarApiResumoKpis(queryString) {
            const url = `http://127.0.0.1:5000/api/analise/resumo-kpis?${queryString}`;
            kpiContainer.innerHTML = `<div class="bg-white p-4 rounded-lg shadow text-center col-span-4"><p class="text-sm text-gray-500">Carregando KPIs...</p></div>`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    kpiContainer.innerHTML = ''; 

                    const formatBRL = (valor) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(valor);
                    const formatPerc = (valor) => (valor * 100).toFixed(1) + '%';
                    
                    const createKpiCard = (titulo, valor) => {
                        const div = document.createElement('div');
                        div.className = "bg-white p-4 rounded-lg shadow text-center";
                        div.innerHTML = `
                            <p class="text-sm font-medium text-gray-500 truncate">${titulo}</p>
                            <p class="text-2xl font-bold text-gray-900">${valor}</p>
                        `;
                        kpiContainer.appendChild(div);
                    };

                    createKpiCard('Faturamento Total', formatBRL(data.faturamento_total));
                    createKpiCard('Ticket Médio', formatBRL(data.ticket_medio));
                    createKpiCard('Pedidos Concluídos', data.pedidos_concluidos.toFixed(0));
                    createKpiCard('Pedidos Cancelados', data.pedidos_cancelados.toFixed(0));
                    createKpiCard('Taxa de Cancelamento', formatPerc(data.taxa_cancelamento));
                    createKpiCard('Clientes Únicos', data.clientes_unicos.toFixed(0));
                    createKpiCard('Frequência (Pedidos/Cliente)', data.frequencia_cliente.toFixed(2));
                    createKpiCard('Gasto Médio por Cliente', formatBRL(data.gasto_medio_cliente));
                })
                .catch(error => {
                    console.error('Erro API KPIs:', error);
                    kpiContainer.innerHTML = `<div class="bg-red-100 p-4 rounded-lg shadow text-center col-span-4"><p class="text-sm font-medium text-red-700">Erro ao carregar KPIs</p></div>`;
                });
        }
        
        // --- 4. REMOVEMOS A FUNÇÃO 'exportarParaPDF' ---
        // (Não é mais necessária)

    </script>
</body>
</html>